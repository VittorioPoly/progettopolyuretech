{% extends 'base.html' %}
{% block content %}
<div class="module-view">
    <h2>
        {% if is_new %}
            Nuovo Dipendente
        {% else %}
            Modifica Dipendente: {{ dip.nome }} {{ dip.cognome }}
        {% endif %}
        - Step {{ step }} di 5
    </h2>
    
    <div class="progress mb-4">
        <div class="progress-bar" role="progressbar" 
             style="width: {{ (step / 5) * 100 }}%"
             aria-valuenow="{{ (step / 5) * 100 }}"
             aria-valuemin="0"
             aria-valuemax="100">
            Step {{ step }} di 5
        </div>
    </div>

    <!-- Show navigation tabs only when editing an existing employee AND on their profile page (not here) -->
    {# Pulsanti di navigazione tra sezioni del profilo non mostrati qui, ma sulla pagina profilo_dipendente #}

    <div class="card">
        <div class="card-body">
        {% if is_new %}
            <form method="POST" action="{{ url_for('modulo8.nuovo_dipendente', step=step, is_new=True) }}">
        {% else %}
            <form method="POST" action="{{ url_for('modulo8.modifica_dipendente_step', id=dip.id, step=step) }}">
        {% endif %}
                {{ form.hidden_tag() }}
                
                {% if step == 1 %}
                    <h4>Dati Personali</h4>
                    <div class="row">
                        <div class="col-md-6">
                            {{ form.nome.label(class="form-label") }}
                            {{ form.nome(class="form-control") }}
                        </div>
                        <div class="col-md-6">
                            {{ form.cognome.label(class="form-label") }}
                            {{ form.cognome(class="form-control") }}
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            {{ form.data_nascita.label(class="form-label") }}
                            {{ form.data_nascita(class="form-control", type="date") }}
                        </div>
                        <div class="col-md-4">
                            {{ form.luogo_nascita.label(class="form-label") }}
                            {{ form.luogo_nascita(class="form-control") }}
                        </div>
                        <div class="col-md-4">
                            {{ form.provincia_nascita.label(class="form-label") }}
                            {{ form.provincia_nascita(class="form-control") }}
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            {{ form.codice_fiscale.label(class="form-label") }}
                            {{ form.codice_fiscale(class="form-control") }}
                        </div>
                        <div class="col-md-4">
                            {{ form.email.label(class="form-label") }}
                            {{ form.email(class="form-control") }}
                        </div>
                        <div class="col-md-4">
                            {{ form.telefono.label(class="form-label") }}
                            {{ form.telefono(class="form-control") }}
                        </div>
                    </div>
                {% elif step == 2 %}
                    <h4>Dati Lavorativi</h4>
                    <div class="row">
                        <div class="col-md-4">
                            {{ form.matricola.label(class="form-label") }}
                            {{ form.matricola(class="form-control") }}
                        </div>
                        <div class="col-md-4">
                            {{ form.reparto.label(class="form-label") }}
                            {{ form.reparto(class="form-control") }}
                        </div>
                        <div class="col-md-4">
                            {{ form.ruolo.label(class="form-label") }}
                            {{ form.ruolo(class="form-control") }}
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            {{ form.data_assunzione_somministrazione.label(class="form-label") }}
                            {{ form.data_assunzione_somministrazione(class="form-control", type="date") }}
                        </div>
                        <div class="col-md-6">
                            {{ form.agenzia_somministrazione.label(class="form-label") }}
                            {{ form.agenzia_somministrazione(class="form-control") }}
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            {{ form.data_assunzione_indeterminato.label(class="form-label") }}
                            {{ form.data_assunzione_indeterminato(class="form-control", type="date") }}
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            {{ form.legge_104.label(class="form-label") }}
                            {{ form.legge_104(class="form-select") }}
                        </div>
                        <div class="col-md-6">
                            {{ form.donatore_avis.label(class="form-label") }}
                            {{ form.donatore_avis(class="form-select") }}
                        </div>
                    </div>
                {% elif step == 3 %}
                    <h4>Dati Residenza</h4>
                    <div class="row">
                        <div class="col-md-12">
                            {{ form.indirizzo_residenza.label(class="form-label") }}
                            {{ form.indirizzo_residenza(class="form-control") }}
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            {{ form.citta_residenza.label(class="form-label") }}
                            {{ form.citta_residenza(class="form-control") }}
                        </div>
                        <div class="col-md-4">
                            {{ form.provincia_residenza.label(class="form-label") }}
                            {{ form.provincia_residenza(class="form-control") }}
                        </div>
                        <div class="col-md-4">
                            {{ form.cap_residenza.label(class="form-label") }}
                            {{ form.cap_residenza(class="form-control") }}
                        </div>
                    </div>
                {% elif step == 4 %}
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0">Step 4: Competenze</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label mb-3 fw-bold">Competenze</label>
                                <div class="competenze-list">
                                    {% for comp in competenze_lista %}
                                        <div class="competenza-item {% if not is_new and comp.id in form.competenze.data %}selected{% endif %}">
                                            <input type="checkbox" 
                                                   name="competenze" 
                                                   value="{{ comp.id }}" 
                                                   id="comp_{{ comp.id }}" 
                                                   class="form-check-input competenza-check-input"
                                                   {% if not is_new and comp.id in form.competenze.data %}checked{% endif %}>
                                            <label class="competenza-label mb-0 ms-2" for="comp_{{ comp.id }}">{{ comp.nome }}</label>
                                            <select name="percentuale_{{ comp.id }}" class="form-select percentuale-select ms-3">
                                                {% set current_percent = dip_competenze_percentuali.get(comp.id, 0) if not is_new else 0 %}
                                                <option value="0" {% if current_percent == 0 %}selected{% endif %}>0%</option>
                                                <option value="25" {% if current_percent == 25 %}selected{% endif %}>25%</option>
                                                <option value="50" {% if current_percent == 50 %}selected{% endif %}>50%</option>
                                                <option value="75" {% if current_percent == 75 %}selected{% endif %}>75%</option>
                                                <option value="100" {% if current_percent == 100 %}selected{% endif %}>100%</option>
                                            </select>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% elif step == 5 %}
                    <h4>Vestiario</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="item_id" class="form-label">Tipo di vestiario</label>
                                <select class="form-select" id="item_id" name="item_id" required>
                                    <option value="" disabled selected>Seleziona...</option>
                                    {% for item in inventory %}
                                        <option value="{{ item.id }}">{{ item.nome }}{% if item.taglia %} ({{ item.taglia }}){% endif %}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="quantita" class="form-label">Quantità da prelevare</label>
                                <input type="number" class="form-control" id="quantita" name="quantita" min="1" required>
                            </div>
                            <button type="submit" name="aggiungi_prelievo" class="btn btn-primary">Aggiungi Prelievo</button>
                        </div>
                        <div class="col-md-6">
                            <h5>Prelievi Effettuati</h5>
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Articolo</th>
                                        <th>Taglia</th>
                                        <th>Quantità</th>
                                        <th>Data</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if is_new %}
                                        {% for p in prelievi %}
                                            {% set item = (inventory | selectattr('id', 'equalto', p.item_id) | list).0 %}
                                            <tr>
                                                <td>{{ item.nome }}</td>
                                                <td>{{ item.taglia or '—' }}</td>
                                                <td>{{ p.quantita }}</td>
                                                <td>—</td>
                                            </tr>
                                        {% else %}
                                            <tr>
                                                <td colspan="4" class="text-center">Nessun prelievo registrato.</td>
                                            </tr>
                                        {% endfor %}
                                    {% elif dip %}
                                        {% for p in dip.prelievi_vestiario %}
                                            <tr>
                                                <td>{{ p.item.nome }}</td>
                                                <td>{{ p.item.taglia or '—' }}</td>
                                                <td>{{ p.quantita }}</td>
                                                <td>{{ p.timestamp.strftime('%d/%m/%Y %H:%M') }}</td>
                                            </tr>
                                        {% else %}
                                            <tr>
                                                <td colspan="4" class="text-center">Nessun prelievo registrato.</td>
                                            </tr>
                                        {% endfor %}
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endif %}

                <div class="mt-4">
                    {% if step > 1 %}
                        <button type="submit" name="action" value="prev" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Indietro
                        </button>
                    {% elif not is_new and step == 1 %}
                         <a href="{{ url_for('modulo8.profilo_dipendente', id=dip.id) }}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Annulla
                        </a>
                    {% endif %}
                    
                    {% if step < 5 %}
                        <button type="submit" name="action" value="next" class="btn btn-primary">
                            Avanti <i class="fas fa-arrow-right"></i>
                        </button>
                    {% else %}
                        <button type="submit" name="action" value="next" class="btn btn-success">
                            <i class="fas fa-save"></i> Salva {% if not is_new %}Aggiornamenti{% endif %}
                        </button>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
{{ super() }}
<style>
/* Progress bar fix */
.progress-bar[role="progressbar"] {
    min-width: 80px;
    font-weight: 500;
    font-size: 1.1rem;
}

.competenze-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.competenza-item {
    display: flex;
    align-items: center;
    background: #fff;
    border-radius: 0.5rem;
    padding: 0.6rem 1rem;
    border: 2px solid #e3e6ea;
    transition: all 0.2s ease;
    gap: 1rem;
}

.competenza-item:hover {
    border-color: #b6d4fe;
    background: #f8fafc;
}

.competenza-item.selected {
    border-color: #2563eb;
    background: #e8f0fe;
}

.competenza-check {
    flex: 0 0 auto;
}

.competenza-check-input {
    width: 1.2em;
    height: 1.2em;
    accent-color: #2563eb;
    margin: 0;
    cursor: pointer;
}

.competenza-label {
    flex: 1;
    font-size: 1rem;
    font-weight: 500;
    color: #222;
    margin: 0;
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.competenza-select {
    flex: 0 0 100px;
}

.percentuale-select {
    width: 100%;
    font-size: 0.95rem;
    border-radius: 0.3rem;
    border: 1px solid #cbd5e1;
    padding: 0.3rem 0.5rem;
}

@media (max-width: 576px) {
    .competenza-item {
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .competenza-label {
        flex: 1 1 100%;
        white-space: normal;
    }
    
    .competenza-select {
        flex: 0 0 100%;
    }
}
</style>
<script>
// Eventuale script per evidenziare .competenza-item.selected dinamicamente al check della checkbox
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.competenza-check-input').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const item = this.closest('.competenza-item');
            if (item) {
                if (this.checked) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            }
        });
    });
});
</script>
{% endblock %}
